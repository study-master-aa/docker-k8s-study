<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>채팅</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    #container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
    #roomForm, #chatForm { display: flex; gap: 8px; margin-top: 16px; margin-bottom: 16px; }
    #msgInput { width: 90%; }
    #chat { border: 1px solid #ddd; border-radius: 4px; height: 300px; overflow-y: auto; padding: 8px; background: #fafafa; }
    #users { border: 1px solid #ddd; border-radius: 4px; padding: 8px; background: #f0f0f0; margin-bottom: 16px; }
    .msgInput { width: 300px; }
    .msg { margin: 4px 0; }
    .msg-user { font-weight: bold; color: #1976d2; }
    table { width: 100%; margin: 8px 0 16px 0; border-collapse: collapse; }
    th, td { padding: 6px; text-align: left; }
    th { background: #f5f5f5; }
    tr { cursor: pointer; }
  </style>
</head>
<body>
  <div id="container">
    <h2>채팅방</h2>
    <form id="roomForm">
      <span>닉네임 </span>
      <input id="userInput" placeholder="닉네임" required />
    </form>
    <div id="roomListSection">
      <table id="roomListTable">
        <thead><tr><th>방 이름</th><th>유저 수</th></tr></thead>
        <tbody id="roomList"></tbody>
      </table>
    </div>
    <div id="chatSection" style="display:none;">
      <button id="backToRooms" style="margin-bottom:12px;">채팅방 목록으로</button>
      <div id="users"></div>
      <div id="chat"></div>
      <form id="chatForm">
        <input id="msgInput" placeholder="메시지 입력" autocomplete="off" required />
        <button type="submit">전송</button>
      </form>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const randomNickname = () => {
      const animals = ['호랑이','사자','토끼','여우','늑대','곰','다람쥐','고양이','강아지','펭귄','부엉이','수달','고래','참새','독수리'];
      const adj = ['귀여운','멋진','용감한','행복한','재빠른','느긋한','똑똑한','엉뚱한','씩씩한','상냥한'];
      return adj[Math.floor(Math.random()*adj.length)] + animals[Math.floor(Math.random()*animals.length)] + Math.floor(Math.random()*100);
    }
    const socket = io();
    const roomForm = document.getElementById('roomForm');
    const userInput = document.getElementById('userInput');
    const chatSection = document.getElementById('chatSection');
    const chat = document.getElementById('chat');
    const users = document.getElementById('users');
    const chatForm = document.getElementById('chatForm');
    const msgInput = document.getElementById('msgInput');
    const roomList = document.getElementById('roomList');
    const roomListTable = document.getElementById('roomListTable');
    const backToRooms = document.getElementById('backToRooms');

    let currentRoom = '';
    let username = '';

    // 랜덤 닉네임 기본값
    userInput.value = randomNickname();

    // 채팅방 목록 불러오기 및 테이블 표시/클릭 입장
    const loadRooms = async () => {
      const res = await fetch('/api/rooms');
      const list = await res.json();
      roomList.innerHTML = '';
      list.forEach(room => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.innerHTML = `<td>${room}</td><td>-</td>`;
        tr.onclick = () => {
          currentRoom = room;
          username = userInput.value.trim() || randomNickname();
          socket.emit('joinRoom', { room: currentRoom, user: username });
          roomForm.style.display = 'none';
          document.getElementById('roomListSection').style.display = 'none';
          chatSection.style.display = '';
        };
        roomList.appendChild(tr);
      });
    };
    loadRooms();

    roomForm.onsubmit = (e) => {
      e.preventDefault();
      // 방 이름 입력 없이 submit 시 아무 동작 안 함
      return false;
    };

    chatForm.onsubmit = (e) => {
      e.preventDefault();
      if (msgInput.value.trim()) {
        socket.emit('sendMessage', msgInput.value);
        msgInput.value = '';
      }
    };

    socket.on('chatHistory', (messages) => {
      chat.innerHTML = '';
      messages.forEach(msg => addMessage(msg));
    });
    socket.on('newMessage', (msg) => addMessage(msg));
    socket.on('userList', (userList) => {
      users.innerHTML = '<b>유저 목록:</b> ' + userList.map(u => `<span style="color:${u.color};font-weight:bold;">${u.name}</span>`).join(', ');
    });

    const addMessage = (msg) => {
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `<span class=\"msg-user\" style=\"color:${msg.color};\">${msg.user}</span>: ${msg.text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    };

    if (backToRooms) {
      backToRooms.onclick = () => {
        socket.emit('leaveRoom', { room: currentRoom, user: username });
        chatSection.style.display = 'none';
        document.getElementById('roomListSection').style.display = '';
        roomForm.style.display = '';
        chat.innerHTML = '';
        users.innerHTML = '';
        currentRoom = '';
      };
    }
  </script>
</body>
</html>
